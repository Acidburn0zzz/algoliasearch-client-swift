<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Offline mode  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset='utf-8'>
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
  </head>
  <body>
    <a title="Offline mode  Reference"></a>
    <header>
      <div class="content-wrapper">
        <p><a href="index.html">AlgoliaSearch Docs</a></p>
      </div>
    </header>
    <div class="content-wrapper">
      <p id="breadcrumbs">
        <a href="index.html">AlgoliaSearch Reference</a>
        <img id="carat" src="img/carat.png" />
        Offline mode  Reference
      </p>
    </div>
    <div class="content-wrapper">
      <nav class="sidebar">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a href="API Client.html">API Client</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/Client.html">Client</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Client/MultipleQueriesStrategy.html">– MultipleQueriesStrategy</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Index.html">Index</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Query.html">Query</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/BrowseIterator.html">BrowseIterator</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Auxiliary types.html">Auxiliary types</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/GeoRect.html">GeoRect</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IndexQuery.html">IndexQuery</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/LatLng.html">LatLng</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/LibraryVersion.html">LibraryVersion</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Offline mode.html">Offline mode</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/OfflineClient.html">OfflineClient</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/MirroredIndex.html">MirroredIndex</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/MirroredIndex/Strategy.html">– Strategy</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/DataSelectionQuery.html">DataSelectionQuery</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Other Global Variables.html">Other Global Variables</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Other Global Variables.html#/s:v13AlgoliaSearch11ErrorDomainSS">ErrorDomain</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Other Enums.html">Other Enums</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Enums/StatusCode.html">StatusCode</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Other Typealiases.html">Other Typealiases</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Other Typealiases.html#/s:13AlgoliaSearch21BrowseIteratorHandler">BrowseIteratorHandler</a>
              </li>
              <li class="nav-group-task">
                <a href="Other Typealiases.html#/s:13AlgoliaSearch17CompletionHandler">CompletionHandler</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">
        <section>
          <section class="section">
            <h1>Offline mode</h1>
            <a href='#overview' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='overview'>Overview</h2>

<p>The API client can be enhanced with offline capabilities. This optional <strong>offline mode</strong> allows you to mirror online indices on local storage, and transparently switch to the local mirror in case of unavailability of the online index, thus providing uninterrupted user experience. You can also explicitly query the mirror if you want.</p>

<p>Because indices can be arbitrarily big, whereas mobile devices tend to be constrained by network bandwidth, disk space or memory consumption, only part of an index&rsquo;s data is usually synchronized (typically the most popular entries, or what&rsquo;s relevant to the user, or close to her location&hellip;). The offline mode lets you control which data subset you want to synchronize, and how often to synchronize it.</p>

<p>Index settings are automatically synchronized, so that your local index will behave exactly as your online index, with a few restrictions:</p>

<ul>
<li><p>If only part of the data is mirrored, queries may obviously return less objects. Counts (hits, facets&hellip;) may also differ.</p></li>
<li><p>Some advanced features are not supported offline. See <a href="#unsupported-features">Unsupported features</a> for more information.</p></li>
</ul>
<a href='#availability' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='availability'>Availability</h3>

<p>Offline features are brought by Algolia&rsquo;s <strong>Offline SDK</strong>, which is actually composed of two separate components:</p>

<ul>
<li><p>The <strong>Offline API Client</strong> is a superset of the regular, online API client (so all your existing code will work without any modification). It is open source; the source code is available on GitHub in the same repository as the online <a href="https://github.com/algolia/algoliasearch-client-swift">Swift API client</a>.</p></li>
<li><p>The <strong>Offline Core</strong> is a closed source component using native libraries. Although it is readily available for download, <em>it is licensed separately</em>, and will not work without a valid <strong>license key</strong>. Please <a href="https://www.algolia.com/">contact us</a> for more information.</p></li>
</ul>
<a href='#setup' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='setup'>Setup</h2>
<a href='#prerequisites' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='prerequisites'>Prerequisites</h3>

<ol>
<li><p>Obtain a <strong>license key</strong> from <a href="https://www.algolia.com/">Algolia</a>.</p></li>
<li><p>Make sure you use an <strong>API key</strong> with the following ACLs:</p></li>
</ol>
<pre class="highlight plaintext"><code>- Search (`search`)
- Browse (`browse`)
- Get index settings (`settings`)

*This is required because the offline mode needs to replicate the online index's settings and uses browse requests when syncing.*
</code></pre>
<a href='#steps' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='steps'>Steps</h3>

<ol>
<li><p>In your Podfile, reference the offline pod:</p>
<pre class="highlight ruby"><code><span class="n">pod</span> <span class="s1">'AlgoliaSearch-Offline-Swift'</span><span class="p">,</span> <span class="s1">'~&gt; ${WHATEVER_IS_THE_LATEST_VERSION}'</span>
</code></pre>

<p><strong>Note:</strong> <em>Because of its intrinsic limitations, Carthage is</em> <strong>not</strong> <em>supported for the offline mode.</em></p></li>
<li><p>When initializing your client, instantiate an <code>OfflineClient</code> instead of a <code>Client</code>:</p>
<pre class="highlight swift"><code><span class="n">client</span> <span class="o">=</span> <span class="kt">OfflineClient</span><span class="p">(</span><span class="nv">appID</span><span class="p">:</span> <span class="s">"YOUR_APP_ID"</span><span class="p">,</span> <span class="nv">apiKey</span><span class="p">:</span> <span class="s">"YOUR_API_KEY"</span><span class="p">)</span>
</code></pre></li>
<li><p>(Optional) Choose the directory under which local indices will be stored:</p>
<pre class="highlight swift"><code><span class="n">client</span><span class="o">.</span><span class="n">rootDataDir</span> <span class="o">=</span> <span class="kt">TODO</span>
</code></pre>

<p>By default, TODO.</p>

<p><em>Warning: although using the cache directory may be tempting, we advise you against doing so. There is no guarantee that all files will be deleted together, and a partial delete could leave an index in an inconsistent state.</em></p></li>
<li><p><strong>Enable offline mode</strong>:</p>
<pre class="highlight java"><code><span class="n">client</span><span class="o">.</span><span class="na">enableOfflineMode</span><span class="o">(</span><span class="s">"YOUR_OFFLINE_CORE_LICENSE_KEY"</span><span class="o">)</span>
</code></pre></li>
</ol>
<a href='#usage' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='usage'>Usage</h2>
<a href='#activation' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='activation'>Activation</h3>

<p>An <code>OfflineClient</code> provides all the features of an online <code>Client</code>. It returns <code>MirroredIndex</code> instances, which in turn provide all the features of online <code>Index</code> instances.</p>

<p>However, until you explicitly enable the offline mode by calling <code>enableOfflineMode()</code>, your offline client behaves like a regular online client. The same goes for indices: <em>you must explicitly activate mirroring</em> by settings the <code>mirrored</code> property to <code>true</code>. The reason is that you might not want to mirror all of your indices.</p>

<p><em>Warning: Calling offline features before enabling mirroring on an index is a programming error and will be punished by an assertion failure.</em></p>
<a href='#synchronization' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='synchronization'>Synchronization</h3>

<p>You have entire control over <em>what</em> is synchronized and <em>when</em>.</p>
<a href='#what' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='what'>What</h4>

<p>First, specify what subset of the data is to be synchronized. You do so by constructing <strong>data selection queries</strong> and setting the <code>MirroredIndex.dataSelectionQueries</code> property.</p>

<p>A <em>data selection query</em> is essentially a combination of a browse <code>Query</code> and a maximum object count. When syncing, the offline index will browse the online index, filtering objects through the provided query (which can be empty, hence selecting all objects), and stopping when the maximum object count has been reached (or at the end of the index, whichever comes first).</p>

<p>It will do so for every data selection query you have provided, then build (or re-build) the local index from the retrieved data. (When re-building, the previous version of the local index remains available for querying, until it is replaced by the new version.)</p>

<p><em>Warning: The entire selected data is re-downloaded at every sync, so be careful about bandwidth usage!</em></p>

<p><em>Warning: It is a programming error to attempt a sync with no data selection queries. Doing so will result in an assertion failure.</em></p>

<p><em>Note: Because the sync uses a <q>browse</q> to retrieve objects, the number of objects actually mirrored may exceed the maximum object count specified in the data selection query (up to one page of results of difference).</em></p>
<a href='#when' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='when'>When</h4>

<p>The easiest way to synchronize your index is to use the <strong>semi-automatic mode</strong>:</p>

<ul>
<li><p>Choose a minimum delay between two syncs by setting <code>MirroredIndex.delayBetweenSyncs</code>. The default is 24 hours.</p></li>
<li><p>Whenever conditions are met for a potential sync (e.g. the device is online), call <code>MirroredIndex.syncIfNeeded()</code>. If the last successful sync is older than the minimum delay, a sync will be launched. Otherwise, the call will be ignored.</p></li>
</ul>

<p>Alternatively, you may call <code>MirroredIndex.sync()</code> to force a sync to happen now.</p>

<p>The reason you have to choose when to synchronize is that the decision depends on various factors that the SDK cannot know, in particular the specific business rules of your application, or the user&rsquo;s preferences. For example, you may want to sync only when connected to a non-metered Wi-Fi network, or during the night.</p>

<p><em>Note: Syncs always happen in the background, and therefore should not impact the user&rsquo;s experience.</em></p>

<p><em>Note: You cannot have two syncs on the same index running in parallel. If a sync is already running, concurrent sync requests will be ignored.</em></p>
<a href='#querying' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='querying'>Querying</h3>
<a href='#transparent-fallback-mode' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='transparent-fallback-mode'>Transparent fallback mode</h4>

<p>You query a mirrored index using the same <code>search()</code> method as a purely online index. This will use the offline mirror as a fallback in case of failure of the online request.</p>

<p>There&rsquo;s a catch, however. A mirrored index can function in two modes:</p>

<ol>
<li><p><strong>Preventive offline search</strong> (default). In this mode, if the online request is too slow to return, an offline request is launched preventively after a certain delay.</p>

<p><em>Warning: This may lead to your completion handler being called twice:</em> a first time with the offline results, and a second time with the online results. However, if the online request is fast enough (and successful, or the error cannot be recovered), the callback will be called just once.</p>

<p>You may adjust the delay setting the <code>MirroredIndex.preventiveOfflineSearchDelay</code> property. The default is <code>MirroredIndex.DefaultPreventiveOfflineSearchDelay</code>.</p></li>
<li><p><strong>Offline fallback.</strong> In this mode, the index first tries an online request, and in case of failure, switches back to the offline mirror, but only after the online request has failed. Therefore, the completion handler is guaranteed to be called exactly once.</p></li>
</ol>

<p>You can switch between those two modes by setting <code>MirroredIndex.preventiveOfflineSearch</code>.</p>

<p>The origin of the data is indicated by the <code>origin</code> attribute in the returned result object: its value is <code>remote</code> if the content originates from the online API, and <code>local</code> if the content originates from the offline mirror.</p>
<a href='#direct-query' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='direct-query'>Direct query</h4>

<p>You may directly target the offline mirror if you want:</p>

<ul>
<li>for search queries: <code>searchMirror()</code></li>
<li>for browse queries: <code>browseMirror()</code> and <code>browseMirrorFrom()</code></li>
</ul>

<p>Those methods have the same semantics as their online counterpart.</p>

<p>Browsing is especially relevant when synchronizing <a href="#associated-resources">associated resources</a>.</p>
<a href='#events' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='events'>Events</h3>

<p>You may be informed of sync events by registering a notification observer on the index for the <code>MirroredIndex.SyncDidStartNotification</code> and <code>MirroredIndex.SyncDidFinishNotification</code> notifications.</p>
<a href='#associated-resources' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='associated-resources'>Associated resources</h3>

<p>In a typical setup, objects from an index are not standalone. Rather, they reference other resources (for example images) that are stored outside of Algolia. They are called <strong>associated resources</strong>.</p>

<p>In order to offer the best user experience, you may want to pre-load some of those resources while you are online, so that they are available when offline.</p>

<p>To do so:</p>

<ul>
<li>register a listener on the mirrored index (see <a href="#events">Events</a> above);</li>
<li>when the sync is finished, browse the local mirror, parsing each object to detect associated resources;</li>
<li>pre-fetch those that are not already available locally.</li>
</ul>

<p><em>Note: You should do so from a background thread with a low priority to minimize impact on the user&rsquo;s experience.</em></p>
<a href='#unsupported-features' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='unsupported-features'>Unsupported features</h2>

<p>Due mainly to binary size constraints, the following features are not supported by the offline mode:</p>

<ul>
<li>plurals dictionary (simple plurals with a final S are still handled)</li>
<li>CJK segmentation</li>
<li>IP geolocation (<code>aroundLatLngViaIP</code> query parameter)</li>
</ul>
<a href='#troubleshooting' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='troubleshooting'>Troubleshooting</h2>
<a href='#logs' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='logs'>Logs</h3>

<p>The SDK logs messages to the console, which can be useful when troubleshooting.</p>

<p>If the SDK does not seem to work, first check for proper initialization in the logs. You should see something like:</p>
<pre class="highlight plaintext"><code>Algolia SDK v1.2.3
Algolia SDK licensed to: Peanuts, Inc.
</code></pre>

<p>Any unexpected condition should result in a warning/error being logged.</p>
<a href='#support' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='support'>Support</h3>

<p>If you think you found a bug in the offline client, please submit an issue on GitHub so that it can benefit the community.</p>

<p>If you have a crash in the offline core, please send us a support request. Make sure to include the <em>crash report</em>, so that we can pinpoint the problem.</p>
<a href='#other-resources' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='other-resources'>Other resources</h2>

<p>The offline client bears extensive documentation comments. Please refer to them for more details.</p>

          </section>
          <section class="section task-group-section">
            <div class="task-group">
              <ul>
                <li class="item">
                  <div>
                    <code>
                    <a name="/s:C13AlgoliaSearch13OfflineClient"></a>
                    <a name="//apple_ref/swift/Class/OfflineClient" class="dashAnchor"></a>
                    <a class="token" href="#/s:C13AlgoliaSearch13OfflineClient">OfflineClient</a>
                    </code>
                  </div>
                  <div class="height-container">
                    <div class="pointer-container"></div>
                    <section class="section">
                      <div class="pointer"></div>
                      <div class="abstract">
                        <p>An API client that adds offline features on top of the regular online API client.</p>

<div class="aside aside-note">
    <p class="aside-title">Note</p>
    Requires Algolia&rsquo;s Offline Core SDK. The <code>enableOfflineMode(...)</code> method must be called with a valid license
key prior to calling any offline-related method.

</div>

                        <a href="Classes/OfflineClient.html" class="slightly-smaller">See more</a>
                      </div>
                      <div class="declaration">
                        <h4>Declaration</h4>
                        <div class="language">
                          <p class="aside-title">Swift</p>
                          <pre class="highlight"><code><span class="kd">@objc</span> <span class="kd">public</span> <span class="kd">class</span> <span class="kt">OfflineClient</span> <span class="p">:</span> <span class="kt"><a href="Classes/Client.html">Client</a></span></code></pre>

                        </div>
                      </div>
                    </section>
                  </div>
                </li>
              </ul>
            </div>
            <div class="task-group">
              <ul>
                <li class="item">
                  <div>
                    <code>
                    <a name="/s:C13AlgoliaSearch13MirroredIndex"></a>
                    <a name="//apple_ref/swift/Class/MirroredIndex" class="dashAnchor"></a>
                    <a class="token" href="#/s:C13AlgoliaSearch13MirroredIndex">MirroredIndex</a>
                    </code>
                  </div>
                  <div class="height-container">
                    <div class="pointer-container"></div>
                    <section class="section">
                      <div class="pointer"></div>
                      <div class="abstract">
                        <p>An online index that can also be mirrored locally.</p>

<p>When created, an instance of this class has its <code>mirrored</code> flag set to false, and behaves like a normal,
online <code><a href="Classes/Index.html">Index</a></code>. When the <code>mirrored</code> flag is set to true, the index becomes capable of acting upon local data.</p>

<div class="aside aside-warning">
    <p class="aside-title">Warning</p>
    It is a programming error to call methods acting on the local data when <code>mirrored</code> is false. Doing so
will result in an assertion error being raised.

</div>

<p>Native resources are lazily instantiated at the first method call requiring them. They are released when the
object is released. Although the client guards against concurrent accesses, it is strongly discouraged
to create more than one <code>MirroredIndex</code> instance pointing to the same index, as that would duplicate
native resources.</p>

<div class="aside aside-note">
    <p class="aside-title">Note</p>
    Requires Algolia&rsquo;s SDK. The <code><a href="Classes/OfflineClient.html#/s:FC13AlgoliaSearch13OfflineClient17enableOfflineModeFSST_">OfflineClient.enableOfflineMode(...)</a></code> method must be called with a valid
license key prior to calling any offline-related method.

</div>

<p><a href='#request-strategy' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='request-strategy'>Request strategy</h3></p>

<p>When the index is mirrored and the device is online, it becomes possible to transparently switch between online and
offline requests. There is no single best strategy for that, because it depends on the use case and the current
network conditions. You can choose the strategy through the <code>requestStrategy</code> property. The default is
<code>FallbackOnFailure</code>, which will always target the online API first, then fallback to the offline mirror in case of
failure (including network unavailability).</p>

<div class="aside aside-note">
    <p class="aside-title">Note</p>
    <p>If you want to explicitly target either the online API or the offline mirror, doing so is always possible
using the <code>searchOnline(...)</code> or <code>searchOffline(...)</code> methods.</p>

</div>

<div class="aside aside-note">
    <p class="aside-title">Note</p>
    <p>The strategy applies both to <code>search(...)</code> and <code>searchDisjunctiveFaceting(...)</code>.</p>

</div>

                        <a href="Classes/MirroredIndex.html" class="slightly-smaller">See more</a>
                      </div>
                      <div class="declaration">
                        <h4>Declaration</h4>
                        <div class="language">
                          <p class="aside-title">Swift</p>
                          <pre class="highlight"><code><span class="kd">@objc</span> <span class="kd">public</span> <span class="kd">class</span> <span class="kt">MirroredIndex</span> <span class="p">:</span> <span class="kt"><a href="Classes/Index.html">Index</a></span></code></pre>

                        </div>
                      </div>
                    </section>
                  </div>
                </li>
                <li class="item">
                  <div>
                    <code>
                    <a name="/s:C13AlgoliaSearch18DataSelectionQuery"></a>
                    <a name="//apple_ref/swift/Class/DataSelectionQuery" class="dashAnchor"></a>
                    <a class="token" href="#/s:C13AlgoliaSearch18DataSelectionQuery">DataSelectionQuery</a>
                    </code>
                  </div>
                  <div class="height-container">
                    <div class="pointer-container"></div>
                    <section class="section">
                      <div class="pointer"></div>
                      <div class="abstract">
                        <p>A data selection query, used to select data to be mirrored locally by a <code><a href="Classes/MirroredIndex.html">MirroredIndex</a></code>.</p>

                        <a href="Classes/DataSelectionQuery.html" class="slightly-smaller">See more</a>
                      </div>
                      <div class="declaration">
                        <h4>Declaration</h4>
                        <div class="language">
                          <p class="aside-title">Swift</p>
                          <pre class="highlight"><code><span class="kd">@objc</span> <span class="kd">public</span> <span class="kd">class</span> <span class="kt">DataSelectionQuery</span><span class="p">:</span> <span class="kt">NSObject</span></code></pre>

                        </div>
                      </div>
                    </section>
                  </div>
                </li>
              </ul>
            </div>
          </section>
        </section>
        <section id="footer">
          <p>&copy; 2016 <a class="link" href="https://github.com/algolia/algoliasearch-client-swift" target="_blank" rel="external">Algolia</a>. All rights reserved. (Last updated: 2016-08-09)</p>
          <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.7.0</a>, a <a class="link" href="http://realm.io" target="_blank" rel="external">Realm</a> project.</p>
        </section>
      </article>
    </div>
  </body>
</div>
</html>
